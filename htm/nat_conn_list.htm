<%
	local util = require "luci.util"
	local value_status = luci.http.formvalue("status")
	if "1" == tostring(value_status) then
		local data = {}
		local script_file = "/usr/lib/lua/luci/scripts/ip_mac.sh"
		local result = util.exec("sh " .. script_file .. " | sed '/127\.0\.0\.1/d' | sed '/0\.0\.0\.0/d' | sed '/10\.251\.251\.251/d' | sed 's/  / /g'")

		local result_tbl = util.split(result, "\n")
		for i, v in ipairs(result_tbl) do
			if v then
				local tmp = {}
				tmp = util.split(v, " ")
				table.insert(data, tmp)
			end
		end
		luci.http.prepare_content("application/json")
		luci.http.write_json(data)
		return
	end
%>

<%+header%>

<style>
input.connfilter{width:80%;}
table td {overflow: hidden; text-overflow: ellipsis; white-space:nowrap; text-align: center;}
table {table-layout: fixed;}
</style>
<script language=javascript type="text/javascript" src="/luci-static/resources/jquery-1.9.1.min.js"></script>
<script src="<%=resource_cbi_js%>"></script>
<script>
function filter_result()
{
	$("#filter-id").toggle();
	keyup_event();
}
function keyup_event()
{
	$(".connfilter").val("");

	/* Simulate a keyup event. */
	var e = $.Event("keyup");
	e.which = 13;
	$(".connfilter").trigger(e);
}
function get_nat_conn_list()
{
	XHR.get('<%=luci.dispatcher.build_url("admin", "status", "network", "nat_conn_list")%>',{status:1},function(x, info)
	{
		var index = 1
		var total = 0
		for (var i = 0; i < info.length; i++)
		{
			var str;
			/* odd line start from zero :) */
			if (0 == i % 2)
				str = "<tr class='cbi-rowstyle-odd'>";
			else
				str = "<tr class='cbi-rowstyle-even'>";
			str = str+"<td>" + index + "</td>";
			str = str+"<td>" + info[i][1] + "</td>";
			str = str+"<td>" + (("MAC_NOT_FOUND"==info[i][2])?"":info[i][2].toUpperCase()) + "</td>";
			str = str+"<td>" + info[i][0] + "</td><td>";
			for(var j=3;j<info[i].length;j++)
			{
				str=str+info[i][j].toUpperCase() + " ";
			}
			str = str + "</td><td class='connlist'></td></tr>";
			$("#content-id").append(str);
			index = index + 1
			total = total + parseInt(info[i][0],10)
			/* Forget the last empty data. */
			if (i == info.length - 2)
				break;
		}
		document.getElementById("conn_num").innerHTML="<%:Connection Number%>"+" / <%:Total%> : "+total
		$(".loading-now").remove();
	});
}
$(document).ready(function() {
	$(".connfilter").keyup(function(e) {
		$(".no-result").remove();
		/* ignore tab. */
		var code = e.keyCode || e.which;
		if ("9" == code) {
			return;
		}

		var $input = $(this),
		inputContent = $input.val().toLowerCase(),
		$panel = $input.parents("#filter-id"),
		column = $panel.find("td").index($input.parents("td"))
		$table = $(".connlist").parent("tr"),
		$rows = $table;
		var $filteredRows = $rows.filter(function() {
			var value = $(this).find("td").eq(column).text().toLowerCase();
			return value.indexOf(inputContent) === -1;
		});
		$rows.show();
		$filteredRows.hide();
		if ($filteredRows.length === $rows.length) {
			$("#content-id").append($('<tr class="no-result"><td colspan="6"><%:No result found%></td></tr>'));
		}
	});
	$("#content-id").append($('<tr class="loading-now"><td colspan="6"><img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>"/></td></tr>'));

	get_nat_conn_list();
});
</script>
<div><fieldset>
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:15%;"/>
			<col style="width:20%;"/>
			<col style="width:25%;"/>
			<col style="width:25%;"/>
			<col style="width:10%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:IP Address%></th>
			<th><%:MAC Address%></th>
			<th id="conn_num"><%:Connection Number%></th>
			<th><%:Detail%></th>
			<th><div><button type="button" class="btn filter button-filter" onclick="filter_result()"><%:Filter%></button></div></th>
		</tr>
		<tr id="filter-id" style="display: none;">
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td></td>
		</tr>
	</table>

	<table class="cbi-section-table">
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:15%;"/>
			<col style="width:20%;"/>
			<col style="width:25%;"/>
			<col style="width:25%;"/>
			<col style="width:10%;"/>
		</colgroup>
		<tbody id="content-id">
		</tbody>
	</table>
</fieldset></div>
<%+footer%>