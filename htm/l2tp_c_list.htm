<%+header%>
<style>
input.connfilter{width:80%;}
table td {overflow: hidden; text-overflow: ellipsis; white-space:nowrap; text-align: center;}
table {table-layout: fixed;}
</style>
<script language=javascript type="text/javascript" src="/luci-static/resources/jquery-1.9.1.min.js"></script>
<script src="<%=resource_cbi_js%>"></script>
<script>
var access_state = "running"
var starth = 1
var numh = 20
var uptime = 0
var uptime_id = ""

function filter_result()
{
	$("#filter-id").toggle()
	if ("none" == $("#filter-id").css("display"))
		access_state = "running"
	else
		access_state = "halt"
	keyup_event()
}

function keyup_event()
{
	$(".connfilter").val("")

	/* Simulate a keyup event. */
	var e = $.Event("keyup")
	e.which = 13
	$(".connfilter").trigger(e)
}

function refresh_time(id, time_sec)
{
	var d = (Math.floor(time_sec / (3600 * 24)))
	var h = (Math.floor(time_sec / 3600) % 24)
	var m = (Math.floor((time_sec % 3600) / 60))
	var s = (Math.floor(time_sec % 60))

	var buff = ""
	if(d > 0 )
		buff = d + ' <%:d%> ' + h + ' <%:h%> ' + m + ' <%:m%> ' + s + ' <%:s%> ';
	else if(0 == d && h > 0)
		buff = h + ' <%:h%> ' + m + ' <%:m%> ' + s + ' <%:s%> ';
	else if(0 == d && 0 == h && m > 0)
		buff = m + ' <%:m%> ' + s + ' <%:s%> ';
	else
		buff = s + ' <%:s%>';

	document.getElementById(id).innerHTML = buff;
}

function refresh()
{
	refresh_time(uptime_id,uptime)
	uptime += 1
}

function sec_to_human(idstr, index)
{
	var str = idstr;
	for (var i = index; ; i++)
	{
		if (document.getElementById(str+"-"+i) != null)
		{
			var old_sec =  document.getElementById(str+"-"+i).innerHTML;
			if (old_sec != 0)
				refresh_time(str+"-"+i, old_sec);
		}
		else
			break;
	}
}

function page_align()
{
	var cont_h = $(".history-section-table").get(0).scrollHeight
	var vis_h = $(".history-section-table").height()
	if (cont_h != vis_h)
		$(".padding-class").css("padding-right","15px")
}

function get_list(param)
{
	if ("running" == access_state)
	{
		XHR.get('<%=luci.dispatcher.build_url("admin","status","get_l2tp_client")%>',{action:param,starth:starth,numh:numh},function(x, info)
		{
			if (info != null) {
				var content,raw,sec_str

				if (info["live_cont"] != null) {
					content = info["live_cont"]
					sec_str = "sec-dynamic"

					for (i=0;i<content.length;i++) {
						var str = ""
						var raw = content[i]

						if (1 == i%2)
							str += "<tr class='cbi-rowstyle-odd'>"
						else
							str += "<tr class='cbi-rowstyle-even'>"
						for (j=0;j<raw.length;j++) {
							if (7 == j) {
								uptime = raw[j]
								uptime_id = sec_str + "-" + (i+1)
								str += "<td class='text-center' id='"+uptime_id+"'></td>"
							}
							else
								str += "<td class='text-center'>"+raw[j]+"</td>"
						}
						str += "<td></td></tr>"
						$(".live-section-table tbody").append(str)
					}
					refresh()
					window.setInterval("refresh()",1000)
					obj = document.getElementById("loading-id")
					if (obj)
						obj.remove()
					$(".live-fieldset-class").show()
				}

				if (info["hist_cont"] != null) {
					content = info["hist_cont"]
					sec_str = "sec-static"
					var num = starth

					for (i=0;i<content.length;i++) {
						var str = ""
						var raw = content[i]

						if (1 == i%2)
							str += "<tr class='cbi-rowstyle-odd'>"
						else
							str += "<tr class='cbi-rowstyle-even'>"
						for (j=0;j<raw.length;j++) {
							if (7 == j)
								str += "<td class='text-center' id='"+sec_str+"-"+num+"'>"+raw[j]+"</td>"
							else
								str += "<td class='text-center'>"+raw[j]+"</td>"
						}
						str += "<td class='connlist'></td></tr>"
						$(".history-section-table tbody").append(str)
						num += 1
					}
					sec_to_human("sec-static",starth)
					starth = num
					obj = document.getElementById("loading-id")
					if (obj)
						obj.remove()
					$(".history-fieldset-class").show()
				} else {
					access_state = "halt"
				}

				page_align()
			}
		});
	}
}

$(document).ready(function() {
	$(".connfilter").keyup(function(e) {
		$(".no-result").remove();
		/* ignore tab. */
		var code = e.keyCode || e.which;
		if ("9" == code) {
			return;
		}

		var $input = $(this),
		inputContent = $input.val().toLowerCase(),
		$panel = $input.parents("#filter-id"),
		column = $panel.find("td").index($input.parents("td"))
		$table = $(".connlist").parent("tr"),
		$rows = $table;
		var $filteredRows = $rows.filter(function() {
			var value = $(this).find("td").eq(column).text().toLowerCase();
			return value.indexOf(inputContent) === -1;
		});
		$rows.show();
		$filteredRows.hide();
		if ($filteredRows.length === $rows.length) {
			$("#history-content-id").append($('<tr class="no-result"><td colspan="9"><%:No result found%></td></tr>'));
		}
	})

	$(".history-section-table").scroll(function(e) {
		if("running" == access_state) {
			var cont_h = $(".history-section-table").get(0).scrollHeight
			var vis_h = $(".history-section-table").height()
			var scroll_y = $(".history-section-table").scrollTop()
			if (scroll_y == cont_h - vis_h) {
				get_list("more")
			}
		}
	})

	$(".loading-class").append($('<img id="loading-id" src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>"/>'));
	get_list("default")
});
</script>
<div>
<div class="loading-class" align="center"></div>
<fieldset class="live-fieldset-class" style="display:none">
	<legend><%:Live%></legend>
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:15%;"/>
			<col style="width:17%;"/>
			<col style="width:13%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:Username%></th>
			<th><%:IP Address%></th>
			<th><%:Gateway%></th>
			<th><%:Server Address%></th>
			<th><%:RX / TX Bytes%></th>
			<th><%:Login Time%></th>
			<th><%:Connection Time%></th>
			<th></th>
		</tr>
	</table>

	<div class="live-section-table" style="max-height:285px;overflow:auto;">
	<table class="live-section-table">
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:15%;"/>
			<col style="width:17%;"/>
			<col style="width:13%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tbody>
		</tbody>
	</table></div>
</fieldset>

<fieldset class="history-fieldset-class" style="display:none">
	<legend><%:History%></legend>
	<div class="padding-class">
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:15%;"/>
			<col style="width:17%;"/>
			<col style="width:13%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:Username%></th>
			<th><%:IP Address%></th>
			<th><%:Gateway%></th>
			<th><%:Server Address%></th>
			<th><%:RX / TX Bytes%></th>
			<th><%:Login Time%></th>
			<th><%:Connection Time%></th>
			<th><div><button type="button" class="btn filter button-filter" onclick="filter_result()"><%:Filter%></button></div></th>
		</tr>
		<tr id="filter-id" style="display: none;">
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td></td>
		</tr>
	</table>
	</div>

	<div class="history-section-table" style="max-height:285px;overflow:auto;">
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:15%;"/>
			<col style="width:17%;"/>
			<col style="width:13%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tbody id="history-content-id">
		</tbody>
	</table></div>
</fieldset>
</div>
<%+footer%>
