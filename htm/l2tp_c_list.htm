<%+header%>
<style>
/* Make text align center. */
.text-center {
	text-align: center;
}

/* The filters input style. */
input.connfilter {
	width: 80%;
}

/* The filter button. */
button.filter-btn {
	color: #3498db;
	background-color: #ffffff;
	padding: 5px;
	border-radius: 4px;
}

/* Content table style */
div.div-table {
	max-height: 285px;
	overflow: auto;
}

/* General table style. */
table td {overflow: hidden; text-overflow: ellipsis; white-space:nowrap; text-align: center;}
table {table-layout: fixed;}
</style>
<script language=javascript type="text/javascript" src="/luci-static/resources/jquery-1.9.1.min.js"></script>
<script src="<%=resource_cbi_js%>"></script>
<script>
var access_state = "running"
var starth = 1
var reqnumh = 20
var errnumh = 0
var uptime = 0

function filter_result()
{
	$("#filter-id").toggle()
	if ("none" == $("#filter-id").css("display"))
		access_state = "running"
	else
		access_state = "halt"
	keyup_event()
}

function keyup_event()
{
	$(".connfilter").val("")

	/* Simulate a keyup event. */
	var e = $.Event("keyup")
	e.which = 13
	$(".connfilter").trigger(e)
}

function change_packets_view(packets)
{
	var num = parseFloat(packets)
	var ret_str

	if (num > 0) {
		if (num > 1024*1024*1024)
			ret_str = parseFloat(num/(1024*1024*1024)).toFixed(1) + "GB"
		else if (num > 1024*1024)
			ret_str = parseFloat(num/(1024*1024)).toFixed(1) + "MB"
		else if (num > 1024)
			ret_str = parseFloat(num/1024).toFixed(1) + "KB"
		else
			ret_str = parseFloat(num).toFixed(1) + "B"
	} else {
		ret_str = "0B"
	}
	
	return ret_str
}

function refresh_time(id, time_sec)
{
	var d = (Math.floor(time_sec / (3600 * 24)))
	var h = (Math.floor(time_sec / 3600) % 24)
	var m = (Math.floor((time_sec % 3600) / 60))
	var s = (Math.floor(time_sec % 60))

	var buff = ""
	if(d > 0 )
		buff = d + ' <%:d%> ' + h + ' <%:h%> ' + m + ' <%:m%> ' + s + ' <%:s%> '
	else if(0 == d && h > 0)
		buff = h + ' <%:h%> ' + m + ' <%:m%> ' + s + ' <%:s%> '
	else if(0 == d && 0 == h && m > 0)
		buff = m + ' <%:m%> ' + s + ' <%:s%> '
	else
		buff = s + ' <%:s%>'

	document.getElementById(id).innerHTML = buff
}

function refresh()
{
	refresh_time("sec-dynamic",uptime)
	uptime += 1
}

function sec_to_human(idstr, index)
{
	var str = idstr;
	for (var i = index; ; i++)
	{
		if (document.getElementById(str+"-"+i) != null)
		{
			var old_sec =  document.getElementById(str+"-"+i).innerHTML
			if (old_sec != 0)
				refresh_time(str+"-"+i, old_sec)
		}
		else
			break;
	}
}

function get_list(param)
{
	if ("running" == access_state)
	{
		XHR.get('<%=luci.dispatcher.build_url("admin","status","get_l2tp_client")%>',{action:param,starth:starth,reqnumh:reqnumh,errnumh:errnumh},function(x, info)
		{
			if (info != null) {
				var errnum = parseInt(info["errnum"])

				if (info["live_cont"] != null) {
					var str = ""
					var raw = info["live_cont"][0]

					str += "<tr class='cbi-rowstyle-odd'>"
					for (var j=0;j<5;j++) {
						str += "<td class='text-center'>"+raw[j]+"</td>"
					}
					str += "<td class='text-center'>"+change_packets_view(raw[5])+"/"+change_packets_view(raw[6])+"</td>"
					str += "<td class='text-center'>"+raw[7]+"</td>"
					uptime = parseInt(raw[8])
					str += "<td class='text-center' id='sec-dynamic'></td></tr>"

					$(".live-section-table tbody").append(str)
					refresh()
					window.setInterval("refresh()",1000)
				}
				if ($(".live-section-table tbody").find("tr").length == 0)
					$(".live-section-table tbody").append($("<tr><td colspan='8'><%:No Online Record!%></td></tr>"));
					

				if (info["hist_cont"] != null) {
					var content = info["hist_cont"]
					var sec_str = "sec-static"
					var num = starth
					var raw

					for (i=0;i<content.length;i++) {
						var str = ""
						raw = content[i]

						if (1 == i%2)
							str += "<tr class='cbi-rowstyle-odd'>"
						else
							str += "<tr class='cbi-rowstyle-even'>"
						for (var j=0;j<5;j++) {
							str += "<td class='text-center'>"+raw[j]+"</td>"
						}
						str += "<td class='text-center'>"+change_packets_view(raw[5])+"/"+change_packets_view(raw[6])+"</td>"
						str += "<td class='text-center'>"+raw[7]+"</td>"
						str += "<td class='text-center connlist' id='"+sec_str+"-"+num+"' colspan='2'>"+parseInt(raw[8])+"</td></tr>"
						$(".history-section-table tbody").append(str)
						num += 1
					}
					sec_to_human("sec-static",starth)
					starth = num
					errnumh = errnum
				} else if (errnum == errnumh && 1 != starth){
					$(".history-section-table tbody").append($("<tr><td colspan='9'><%:The end%></td></tr>"));
					access_state = "halt"
				} else {
					errnumh = errnum
					access_state = "running"
				}
				if ($(".history-section-table tbody").find("tr").length == 1)
					$(".history-section-table tbody").append($("<tr><td class='text-center' colspan='9'><%:No History Record!%></td></tr>"));

/*
				$(".div-table td").mouseover(function(e){
					$("#ccc").text($(this).width()+","+$(this)[0].scrollWidth+","+$(this).outerWidth(false))
				})

				$(".div-table td").mouseout(function(e){
				})
*/
			}
			$(".history-section-table tbody").find("#loading-id").remove()
		});
	}
}

$(document).ready(function() {
	$(".connfilter").keyup(function(e) {
		$(".no-result").remove();
		/* ignore tab. */
		var code = e.keyCode || e.which;
		if ("9" == code) {
			return;
		}

		var $input = $(this),
		inputContent = $input.val().toLowerCase(),
		$panel = $input.parents("#filter-id"),
		column = $panel.find("td").index($input.parents("td"))
		$table = $(".connlist").parent("tr"),
		$rows = $table;
		var $filteredRows = $rows.filter(function() {
			var value = $(this).find("td").eq(column).text().toLowerCase();
			return value.indexOf(inputContent) === -1;
		});
		$rows.show();
		$filteredRows.hide();
		if ($filteredRows.length === $rows.length) {
			$(".history-section-table tbody").append($("<tr class='no-result'><td colspan='9'><%:No result found%></td></tr>"));
		}
	})

	
	$(".history-section-table").scroll(function(e) {
		if("running" == access_state) {
			var cont_h = $(".history-section-table").get(0).scrollHeight
			var vis_h = $(".history-section-table").height()
			var scroll_y = $(".history-section-table").scrollTop()
			if (scroll_y == cont_h - vis_h) {
				get_list("more")
			}
		}
	})

	$(".history-section-table tbody").append($("<tr id='loading-id'><td colspan='9'><img src='<%=resource%>/icons/loading.gif' alt='<%:Loading%>'/></td></tr>"));
	get_list("default")
});
</script>
<div>
<fieldset>
	<legend><%:Online%></legend>
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:13%;"/>
			<col style="width:17%;"/>
			<col style="width:20%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:Username%></th>
			<th><%:IP Address%></th>
			<th><%:Gateway%></th>
			<th><%:Server Address%></th>
			<th><%:RX / TX Bytes%></th>
			<th><%:Login Time%></th>
			<th><%:Connection Time%></th>
		</tr>
	</table>

	<div class="table-div live-section-table">
	<table class="live-section-table">
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:13%;"/>
			<col style="width:17%;"/>
			<col style="width:20%;"/>
		</colgroup>
		<tbody>
		</tbody>
	</table></div>
</fieldset>

<fieldset>
	<legend><%:History%></legend>
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:13%;"/>
			<col style="width:17%;"/>
			<col style="width:15%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:Username%></th>
			<th><%:IP Address%></th>
			<th><%:Gateway%></th>
			<th><%:Server Address%></th>
			<th><%:RX / TX Bytes%></th>
			<th><%:Login Time%></th>
			<th><%:Connection Time%></th>
			<th><div><button type="button" class="filter-btn" onclick="filter_result()"><%:Filter%></button></div></th>
		</tr>
		<tr id="filter-id" style="display: none;">
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td></td>
		</tr>
	</table>

	<div class="div-table history-section-table">
	<table>
		<colgroup>
			<col style="width:5%;"/>
			<col style="width:9%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:12%;"/>
			<col style="width:13%;"/>
			<col style="width:17%;"/>
			<col style="width:15%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tbody>
		</tbody>
	</table></div>
</fieldset>
</div>
<div id="ccc">aaa</div>
<%+footer%>
