<%
	local util = require "luci.util"
	local fs_server = require "luci.scripts.fs_server"
	local drv_str = util.exec("lsmod | sed -n '/^rt2x00/p;/^rt2860v2_ap/p;/^rt2860v2_sta/p;'")
	drv_str = drv_str:match("(rt2860v2_ap)") or drv_str:match("(rt2860v2_sta)") or drv_str:match("(rt2x00)") or ""

	if luci.http.formvalue("status") == "1" then
		local wifi_status
		if drv_str == "rt2860v2_ap" or drv_str == "rt2860v2_sta" then
			wifi_status =  util.exec("ifconfig | grep 'ra0'")
		elseif drv_str == "rt2x00" then
			wifi_status =  util.exec("ifconfig | grep 'wlan0'")
		end

		if wifi_status and wifi_status ~= "" then
			local wifi_list = fs_server.get_wifi_list("refresh") or {}

			if next(wifi_list) then
				luci.http.prepare_content("application/json")
				luci.http.write_json(wifi_list)
			end
		end

		return
	end
-%>

<%+header%>
<style>
/* Make text align center. */
.text-center {
	text-align: center;
}

/* The filters input style. */
input.connfilter {
	width: 80%;
}

/* The filter button. */
button.filter-btn {
	color: #3498db;
	background-color: #ffffff;
	padding: 5px;
	border-radius: 4px;
}

/* Content table style */
div.div-table {
	max-height: 285px;
	overflow: auto;
}

/* General table style. */
table td {overflow: hidden; text-overflow: ellipsis; white-space:nowrap; text-align: center;}
table {table-layout: fixed;}
</style>
<script language=javascript type="text/javascript" src="/luci-static/resources/jquery-1.9.1.min.js"></script>
<script src="<%=resource_cbi_js%>"></script>
<script>
function hasSVG(){
	return !!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg','svg').createSVGRect;
}
var SVG_support=true
function filter_result()
{
	$("#filter-id").toggle();
	keyup_event();
}

function keyup_event()
{
	$(".connfilter").val("")

	/* Simulate a keyup event. */
	var e = $.Event("keyup")
	e.which = 13
	$(".connfilter").trigger(e)
}

function change_encryption_view(encryption)
{
	var enc = encryption
	var ret = ""

	if (enc.indexOf('WPA2') >= 0) {
		ret = "WPA2+PSK"
	} else if (enc.indexOf('WPA1') >= 0) {
		ret = "WPA+PSK"
	} else if (enc.indexOf('WEP') >= 0) {
		ret = "WEP"
	} else if (enc.indexOf('AES') >= 0) {
		ret = "AES"
	} else if (enc.indexOf('NONE') >= 0) {
		ret = "NONE"
	} else {
		ret = "WPA+PSK"
	}

	return ret
}
function remove_unexist_ssid_graph(info)
{
	var ssids=document.getElementsByName("ssid_graph")
	for(i=ssids.length-1;i>=0;i--)
	{
		var flag=true
		if(info != null)
		{
			for(j=0;j<info.length;j++)
			{
				if(info[j]["bssid"]==ssids[i].id)
				{
					flag=false
					break
				}
			}
		}
		if(flag)
		{
			document.getElementById("chn_map").removeChild(document.getElementById(ssids[i].id+"_text"))
			document.getElementById("chn_map").removeChild(document.getElementById(ssids[i].id))
			
		}
	}
}
function hightlight(id)
{
	document.getElementById(id).setAttribute('fill-opacity','1')
}
function hightlight_cancel(id)
{
	document.getElementById(id).setAttribute('fill-opacity','0.2')
}
function sort_by_element(element)
{
	return function(a, b) {
		var var1 = a[element]
		var var2 = b[element]
		if (var1 && var2) {
			if ("channel" == element) {
				if (!isNaN(var1) && !isNaN(var2)) {
					var1 = Number(var1)
					var2 = Number(var2)
					return var1-var2
				}
			}
		} else if (!var1 && var2) {
			return 1
		}

		return -1
	}
}
function get_list()
{
	XHR.poll(5, '<%=REQUEST_URI%>',{status:1},function(x,info)
	{
		$("#content-id").empty()
		if (info != null) {
			info.sort(sort_by_element("channel"))
			for (i=0; i<info.length; i++) {
				var str = ""

				if (0 == i%2)
					str += "<tr class='cbi-rowstyle-odd'"
				else
					str += "<tr class='cbi-eowstyle-even'"

				if(SVG_support)
					str=str+="onmouseover=\"hightlight('"+info[i]["bssid"]+"')\" onmouseout=\"hightlight_cancel('"+info[i]["bssid"]+"')\">"
				else
					str=str+=">"

				str += "<td class='text-center'>" + (i+1) + "</td>"
				str += "<td class='text-center'>" + info[i]["channel"] + "</td>"
				str += "<td class='text-center'>" + info[i]["ssid"] + "</td>"
				str += "<td class='text-center'>" + info[i]["bssid"] + "</td>"
				str += "<td class='text-center'>" + change_encryption_view(info[i]["encryption"]) + "</td>"
				str += "<td class='text-center connlist' colspan='2'>" + info[i]["signal"] + "</td></tr>"

				if(SVG_support)
				{
					var xmlns = "http://www.w3.org/2000/svg"
					var ssid_obj=document.getElementById(info[i]["bssid"])
					var signal_level=info[i]["signal"].replace(/[^0-9]/ig,"")
					<% if drv_str == "rt2860v2_ap" then %>
					var y=signal_level*3
					var color="#3498db"
					if(signal_level>=70)
						color="#008100"
					else if(signal_level <= 40)
						color="#fe5a56"
					<% else %>
					var y=300-signal_level*3
					var color="#3498db"
					if(signal_level>=80)
						color="#fe5a56"
					else if(signal_level <= 55)
						color="#008100"
					<% end %>
					var x_start=info[i]["channel"]*50-10
					var x_end=info[i]["channel"]*50+190
					var d_data="M"+x_start+" 360 A 100 "+y+" 0,1,1, "+x_end+" 360 L "+x_start+" 360"
					

					if(!ssid_obj)
					{
						var path_obj=document.createElementNS(xmlns,"path")
						path_obj.setAttribute('id',info[i]["bssid"]);
						path_obj.setAttribute('name',"ssid_graph");
						path_obj.setAttribute('d',d_data);
						path_obj.setAttribute('stroke',color);
						path_obj.setAttribute('stroke-width',"1");
						path_obj.setAttribute('fill',color);
						path_obj.setAttribute('fill-opacity',"0.2");
						document.getElementById("chn_map").appendChild(path_obj)
						var text_obj=document.createElementNS(xmlns,"text")
						text_obj.setAttributeNS(null,"id",info[i]["bssid"]+"_text")
						text_obj.setAttributeNS(null,"x",info[i]["channel"]*50+70)
						text_obj.setAttributeNS(null,"y",347-y)
						text_obj.setAttributeNS(null,"fill",color)
						var theMSG = document.createTextNode(info[i]["ssid"]);
						text_obj.appendChild(theMSG)
						document.getElementById("chn_map").appendChild(text_obj)
					}
					else
					{
						ssid_obj.setAttribute('d',d_data);
						ssid_obj.setAttribute('stroke',color);
						ssid_obj.setAttribute('fill',color);
						var text_obj=document.getElementById(info[i]["bssid"]+"_text")
						text_obj.setAttribute("x",info[i]["channel"]*50+70)
						text_obj.setAttribute("fill",color)
						text_obj.setAttribute("y",347-y)
					}
				}
				$("#content-id").append(str)

				if("none" != $("#filter-id").css("display")) {
					$("#filter-id input").each(function(){
						if($(this).val().length > 0)
							$(this).keyup()
					})
				}
			}
			$(".filter-btn").show()
		} else {
			$("#content-id").append($("<tr class=cbi-rowstyle-odd><td colspan='7' style='background:#9a9a9a'><%:Disabled%></td></tr>"))
			$(".filter-btn").hide()
		}
		if(SVG_support)
			remove_unexist_ssid_graph(info)
	})
}

$(document).ready(function(){
	SVG_support=hasSVG()
	if(SVG_support)
		document.getElementById("chn_map").style.display=""
	else
		document.getElementById("alert-msgbox").style.display=""

	$(".connfilter").keyup(function(e) {
		$(".no-result").remove()
		/* ignore tab. */
		var code = e.keyCode || e.which
		if ("9" == code) {
			return;
		}

		var $input = $(this)
		inputContent = $input.val().toLowerCase()
		$panel = $input.parents("#filter-id")
		column = $panel.find("td").index($input.parents("td"))
		$table = $(".connlist").parent("tr")
		$rows = $table
		var $filteredRows = $rows.filter(function() {
			var value = $(this).find("td").eq(column).text().toLowerCase()
			return value.indexOf(inputContent) === -1
		})
		$rows.show()
		$filteredRows.hide()
		if ($filteredRows.length === $rows.length) {
			$("#content-id").append($('<tr class="no-result"><td colspan="8"><%:No result found%></td></tr>'))
		}
	})
	$("#content-id").append($('<tr class="loading-now"><td colspan="8"><img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>"/></td></tr>'))
	get_list()
})

</script>
<style type="text/css">
table td {overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
table {table-layout:fixed;}
</style>
<svg id="chn_map" xmlns="http://www.w3.org/2000/svg" version="1.1" height=390 width=940 style="display:none">
<line x1="40" y1="360" x2="940" y2="360" style="stroke:black;stroke-width:1"/>
<line x1="40" y1="360" x2="40" y2="40" style="stroke:black;stroke-width:1"/>

<% if drv_str == "rt2860v2_ap" then %>
<text x="10" y="324" fill="red">10%</text>
<text x="10" y="294" fill="red">20%</text>
<text x="10" y="264" fill="red">30%</text>
<text x="10" y="234" fill="blue">40%</text>
<text x="10" y="204" fill="blue">50%</text>
<text x="10" y="174" fill="blue">60%</text>
<text x="10" y="144" fill="green">70%</text>
<text x="10" y="114" fill="green">80%</text>
<text x="10" y="84" fill="green">90%</text>
<line x1="40" y1="320" x2="940" y2="320" style="stroke:red;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="290" x2="940" y2="290" style="stroke:red;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="260" x2="940" y2="260" style="stroke:red;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="230" x2="940" y2="230" style="stroke:blue;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="200" x2="940" y2="200" style="stroke:blue;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="170" x2="940" y2="170" style="stroke:blue;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="140" x2="940" y2="140" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="110" x2="940" y2="110" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="80" x2="940" y2="80" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<text x="10" y="35"><%:Signal Strength%></text>
<% else %>
<text x="15" y="324" fill="red">-90</text>
<text x="15" y="294" fill="red">-80</text>
<text x="15" y="264" fill="blue">-70</text>
<text x="15" y="234" fill="blue">-60</text>
<text x="15" y="204" fill="green">-50</text>
<text x="15" y="174" fill="green">-40</text>
<text x="15" y="144" fill="green">-30</text>
<text x="15" y="114" fill="green">-20</text>
<text x="15" y="84" fill="green">-10</text>
<line x1="40" y1="320" x2="940" y2="320" style="stroke:red;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="290" x2="940" y2="290" style="stroke:red;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="260" x2="940" y2="260" style="stroke:blue;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="230" x2="940" y2="230" style="stroke:blue;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="200" x2="940" y2="200" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="170" x2="940" y2="170" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="140" x2="940" y2="140" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="110" x2="940" y2="110" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<line x1="40" y1="80" x2="940" y2="80" style="stroke:green;stroke-width:1" stroke-dasharray="1,3"/>
<text x="15" y="35"><%:Signal%> [dBm]</text>
<% end %>
<text x="136" y="380">1</text>
<text x="186" y="380">2</text>
<text x="236" y="380">3</text>
<text x="286" y="380">4</text>
<text x="336" y="380">5</text>
<text x="386" y="380">6</text>
<text x="436" y="380">7</text>
<text x="486" y="380">8</text>
<text x="536" y="380">9</text>
<text x="583" y="380">10</text>
<text x="633" y="380">11</text>
<text x="683" y="380">12</text>
<text x="733" y="380">13</text>
<line x1="140" y1="360" x2="140" y2="365" style="stroke:black;"/>
<line x1="190" y1="360" x2="190" y2="365" style="stroke:black;"/>
<line x1="240" y1="360" x2="240" y2="365" style="stroke:black;"/>
<line x1="290" y1="360" x2="290" y2="365" style="stroke:black;"/>
<line x1="340" y1="360" x2="340" y2="365" style="stroke:black;"/>
<line x1="390" y1="360" x2="390" y2="365" style="stroke:black;"/>
<line x1="440" y1="360" x2="440" y2="365" style="stroke:black;"/>
<line x1="490" y1="360" x2="490" y2="365" style="stroke:black;"/>
<line x1="540" y1="360" x2="540" y2="365" style="stroke:black;"/>
<line x1="590" y1="360" x2="590" y2="365" style="stroke:black;"/>
<line x1="640" y1="360" x2="640" y2="365" style="stroke:black;"/>
<line x1="690" y1="360" x2="690" y2="365" style="stroke:black;"/>
<line x1="740" y1="360" x2="740" y2="365" style="stroke:black;"/>
<text x="850" y="380"><%:WIFI Channel%></text>

</svg>
<div class='container container-msg' id='alert-msgbox' style="display:none">
	<div class='alert-message error'>
	<h4><%:Sorry, your brower does not support SVG !%></h4>
	<%:WIFI Channel Map will not displayed !%><br>
	</div>
</div>
<div>
<fieldset>
	<legend><%:Wireless AP List%></legend>
	<table>
		<colgroup>
			<col style="width:10%;"/>
			<col style="width:10%;"/>
			<col style="width:20%;"/>
			<col style="width:20%;"/>
			<col style="width:20%;"/>
			<col style="width:15%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tr>
			<th><%:Index%></th>
			<th><%:Channel%></th>
			<th><%:SSID%></th>
			<th><%:BSSID / MAC%></th>
			<th><%:Encryption%></th>
			<th style="padding-left:50px"><%:Signal%></th>
			<th><div><button type="button" class="filter-btn" onclick="filter_result()" style="display:none"><%:Filter%></button></div></th>
		</tr>
		<tr id="filter-id" style="display: none;">
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td><input type="text" class="connfilter"/></td>
			<td colspan="2"><input type="text" class="connfilter"/></td>
		</tr>
	</table>

	<table class="div-table cbi-section-table">
		<colgroup>
			<col style="width:10%;"/>
			<col style="width:10%;"/>
			<col style="width:20%;"/>
			<col style="width:20%;"/>
			<col style="width:20%;"/>
			<col style="width:15%;"/>
			<col style="width:5%;"/>
		</colgroup>
		<tbody id="content-id">
		</tbody>
	</table>
</fieldset>
</div>
<%+footer%>
