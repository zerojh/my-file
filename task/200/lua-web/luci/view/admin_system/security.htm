<%+header%>
<%
local disp = require "luci.dispatcher"
local uci = require "luci.model.uci".cursor()
local current_user = disp.context.authuser
local current_web_access = uci:get("user",current_user.."_web","system_security")
local MAX_USER = tonumber(uci:get("profile_param","global","max_user") or "4")
%>
<style type="text/css">
#change_password td{
	text-align:left;
}
.error-tip {
color:#b94a48;
}
.password-strength .meter {
margin: 4px 0;
height: 5px;
background: #f5f5f5;
}
.password-strength .meter #strength-bar {
display: block;
height: 100%;
width: 0px;
}
.password-strength .meter .short {
background: #a03;
}
.password-strength .meter .good {
background: #2d98f3;
}
.password-strength .meter .fair {
background: #fc3;
}
.password-strength .meter .strong {
background: #76c261;
}
</style>
<script language="JavaScript" type="text/JavaScript">
var ratingMsgs = ['<%:Too short, use 8 to 32 characters%>','<%:Weak%>','<%:Fair%>','<%:Good%>','<%:Strong%>','<%:Too long, use 8 to 32 characters%>']
var ratingclass = ['short','short','fair','good','strong']
function passwordGrade(pwd)
{
	var score = 0;
	var regexArr = ['[0-9]', '[a-z]', '[A-Z]', '[\\W_]'];
	var repeatCount = 0;
	var prevChar = '';
	//长度一个加一分，大于5开始算，大于18按18算
	var len = pwd.length;
	if (pwd.length > 5)
		score += len > 18 ? 18 : len;
	//字符类型多一个加4分
	for (var i = 0, num = regexArr.length; i < num; i++) {
		if (eval('/' + regexArr[i] + '/').test(pwd)) {
			score += 4;
		}
	}
	for (var i = 0, num = regexArr.length; i < num; i++)
	{
		if (pwd.match(eval('/' + regexArr[i] + '/g')) && pwd.match(eval('/' + regexArr[i] + '/g')).length >= 2) {
			score += 2;
		}
		if (pwd.match(eval('/' + regexArr[i] + '/g')) && pwd.match(eval('/' + regexArr[i] + '/g')).length >= 5) {
			score += 2;
		}
	}
	//重复一次减一分
	for (var i = 0, num = pwd.length; i < num; i++) {
		if (pwd.charAt(i) == prevChar) {
			repeatCount++;
		}
		else {
			prevChar = pwd.charAt(i);
		}
	}
	score -= repeatCount * 1;
	return score;
}

function pwStrength()
{
	var pwd = document.getElementById("newpw_1").value
	if (pwd == null || pwd == '') {
		refresh(0);
		return false;
	}
	else
	{
		if (pwd.length < 8) {
			refresh(0);
			return false;
		}
		var level;
		mark = passwordGrade(pwd);
		//弱
		if (mark <= 10)
			level = 1;
		else if (mark > 10 && mark <= 20)
			level = 2;
		else if (mark > 20 && mark <= 30)
			level = 3;
		else if (mark > 30)
			level = 4;
		refresh(level,pwd.length);
	}
	if(pwd.length > 32)
		return false
	else
		return true;
}
function pwConfirm()
{
	if(document.getElementById("newpw_2").value != document.getElementById("newpw_1").value)
	{
		document.getElementById("confirm_result").innerHTML = "<%:Confirmation did not match, please check !%>"
		return false
	}
	else
	{
		document.getElementById("confirm_result").innerHTML = ""
		return true
	}
}
function refresh(level,len)
{
	document.getElementById("ratingfield").style.display = ""
	document.getElementById("strength-bar").style.width = 100 * (level+1) / 5 + "%"
	if(len > 32)
		document.getElementById("passwdRating").innerHTML = ratingMsgs[5]
	else
		document.getElementById("passwdRating").innerHTML = ratingMsgs[level]
	document.getElementById("strength-bar").className = ratingclass[level]
}
function user_check()
{
	if("" == document.getElementById("user").value)
	{
		document.getElementById("username_chk_result").innerHTML = "<%:Username can not be empty !%>"
		return false
	}
	else
	{
		document.getElementById("username_chk_result").innerHTML = ""
		return true
	}
}
function oldpw_check()
{
	if("" == document.getElementById("oldpw").value)
	{
		document.getElementById("oldpw_chk_result").innerHTML = "<%:Please input old password !%>"
		return false
	}
	else
	{
		document.getElementById("oldpw_chk_result").innerHTML = ""
		return true
	}
}
function form_check()
{
	var userchk = user_check()
	var opwdchk = oldpw_check()
	var npwdchk = pwStrength()
	var cpwdchk = pwConfirm()
	if(userchk && opwdchk && npwdchk && cpwdchk)
	{
		document.pwd.action = document.pwd.action + "?action=save"
		return true
	}
	else
	{
		alert("<%:Some fields are invalid !%>")
		return false
	}
}
</script>
<% if message then %>
<div class='container container-msg'>
	<% if string.find(string.lower(message),"succ") then %>
	<div class="alert-message success"><%=translate(message)%></div>
	<% else %>
	<div class="alert-message error"><%=translate(message)%></div>
	<% end %>
</div>
<% end %>
<h2><a id="content" name="content"><%:System / User Manager%></a></h2>
<fieldset class="cbi-section">
	<legend><%:Modify Password%></legend>
	<form method="post" name="pwd" action="<%=REQUEST_URI%>" enctype="multipart/form-data" onsubmit="return form_check();">
		<table id="change_password">
			<tr>
				<td width="30%"><%:Current Username%></td>
				<td width="20%" style="text-align:center;"><input type="text" class="cbi-input-text" value="<%=current_user%>" name="user" id="user" onBlur="user_check();"/></td>
				<td width="30%" id="username_chk_result" class="error-tip" ></td>
			</tr>
			<tr>
				<td><%:Old Password%></td>
				<td style="text-align:center;"><input type="password" class="cbi-input-text" value="" name="oldpw" id="oldpw" onBlur="oldpw_check();"/></td>
				<td id="oldpw_chk_result" class="error-tip"></td>
			</tr>
			<tr>
				<td><%:New Password%></td>
				<td style="text-align:center;" ><input type="password" class="cbi-input-text" value="" onkeyup="pwStrength();" onBlur="pwStrength();" name="newpw_1" id="newpw_1"/></td>
				<td class="error-tip">
					<div id="ratingfield" class="password-strength" style="width:93%;display:none;">
						<p style="margin-left:0px;"><strong><%:Password Strength%> : </strong><span id="passwdRating"></span></p>
						<div class="meter" id="passwdBar">
							<span id="strength-bar" class="" style="width: 255px;"></span>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td><%:Confirm New Password%></td>
				<td style="text-align:center;" ><input type="password" class="cbi-input-text" value="" onBlur="pwConfirm(this.value);" name="newpw_2" id="newpw_2"/></td>
				<td id="confirm_result" class="error-tip"></td>
			</tr>
			<% if "admin" == current_user or (current_web_access and current_web_access:match("edit")) then %>
			<tr>
				<td></td>
				<td style="text-align:center;">
					<div class="cbi-page-actions">
					<input class="cbi-button cbi-button-save" type="submit" style="width:100px;" name="save" id="save" value="<%:Save%>" />
					</div>
				</td>
				<td></td>
			<% end %>
			</tr>
		</table>
	</form>
</fieldset>
<% if current_user == "admin" then %>
<form name="form" method="post" action="<%=REQUEST_URI%>" enctype="multipart/form-data" >
<div>
	<fieldset class="cbi-section">
		<legend><%:Other User Manager%></legend>
		<table id="mobile" class="cbi-section-table">
			<colgroup>
				<col style="width:20%">
				<col style="width:20%">
				<col style="width:20%">
				<col style="width:20%">
				<col style="width:10%">
				<col style="width:10%">
			</colgroup>
			<tbody>
				<tr class="cbi-section-table-titles">
					<th><%:Username%></th>
					<th><%:User Group%></th>
					<th><%:Expiration%></th>
					<th><%:Description%></th>
					<th><%:Status%></th>
					<th></th>
				</tr>
	<%
	if user_list and #user_list > 0 then
		for k,v in ipairs(user_list) do
			local str=""
			if 1 == k%2 then
				str=str.."<tr class='cbi-rowstyle-odd'"
			else
				str=str.."<tr class='cbi-rowstyle-even'"
			end

			if content_invalid and content_invalid[k] then
				str=str.."style='background:#9a9a9a'"
			end

			if more_info and "" ~= more_info[k] then
				str=str.."onmouseover='display_more_info(this,"..k..")'".."onmouseout='hide_more_info()'>"
			else
				str=str..">"
			end

			str=str.."<td>"..v.name.."</td>"
			str=str.."<td>"..v.group.."</td>"
			str=str.."<td>"..v.expires.."</td>"
			str=str.."<td>"..v.description.."</td>"
			str=str.."<td>"..translate(v.status).."</td>"

			str=str.."<td><a href=\""..v.edit.."\" title='"..translate("Edit").."'><img style='border:none' src='/luci-static/resources/cbi/edit.png'></a>"
			if "Disabled" == v.status then
				str=str.."<input type='image' value='Enabled' name='Action.Enabled."..v.name.."' alt='Enabled' title='"..translate("The status is disabled, click enable").."' src='/luci-static/resources/cbi/apply.png' />"
			else
				str=str.."<input type='image' value='Disabled' onclick='return true' name='Action.Disabled."..v.name.."' alt='Disabled' title='"..translate("The status is enabled, click disable").."' src='/luci-static/resources/cbi/stop.png' />"
			end
			str=str.."<input type='image' value='Delete' name='Action.Delete."..v.name.."' alt='Delete' title='"..translate("Delete").."' src='/luci-static/resources/cbi/remove.png' />"
			write(str.."</td></tr>")
		end
	else
		write("<tr><td colspan='6'>"..translate("This section contains no values yet").."</td></tr>")
	end
	%>
			</tbody>
		</table>
		<% if user_list and #user_list < MAX_USER then
			write("<div><a href='"..user_add_url.."'><input class='cbi-button cbi-button-add' type='button' value='"..translate("New").."' name='New' title='"..translate("New").."'></div>")
		end%>
	</fieldset>
</div></form>
<% end %>
<%+footer%>
