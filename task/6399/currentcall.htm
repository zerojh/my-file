<%
	local sqlite = require "luci.scripts.sqlite3_service"
	local uci = require "luci.model.uci".cursor()

	function full_name(name)
		local interface=uci:get("system","main","interface") or ""
		if string.find(name,"sofia") then
			local cfg_tb
			local info
			local is_trunk
			
			if string.find(name,"sofia/gateway") then
				info = name:match("sofia/gateway/[0-9]+_([0-9]+)")
				cfg_tb = uci:get_all("endpoint_siptrunk")
				is_trunk = true
			elseif string.find(name,"sofia/user") then
				info = name:match("soifa/user/([0-9]+)/.*")
				if not info then
					info = name:match(".*/.*/(.*)@.*")
				end
				cfg_tb = uci:get_all("endpoint_sipphone")
				is_trunk = false
			elseif string.find(name,"sofia/unknown/") then
				local id,addr = name:match("sofia/unknown/(%d+)/.+@(.+):")
				if not id or not addr then
					id,addr = name:match("sofia/unknown/(%d+)/.+@(.+)")
				end
				return "SIP Profile/"..(id or "").."/"..(addr or "")
			end
			
			for k,v in pairs(cfg_tb) do
				if is_trunk then
					if (info == v.index) and v.name then
						return "SIP Trunk/"..v.index.."/"..v.name
					end
				else
					if v.name and v.user == info and v.index then
						return "SIP Extension/"..v.index.."/"..v.name
					end
				end
			end
		elseif string.find(name,"FreeTDM") or string.find(name,"freetdm") then
			local slot,chan = name:match("[a-zA-Z]+/(%d+)[:/](%d+)")

			if chan == "2" then
				if interface:match("2O") then
					return "FXO/Port 1"
				elseif interface:match("2S") then
					return "FXS/Port 1"
				else
					return "FXO"
				end
			else
				if interface:match("2O") then
					return "FXO/Port 0"
				elseif interface:match("2S") then
					return "FXS/Port 0"
				else
					return "FXS"
				end
			end
		elseif string.find(name,"gsmopen") then
			return "GSM"
		else
			return ""
		end
	end
	
	if luci.http.formvalue("status") == "1" then
		local call_detailed_info = sqlite.sqlite3_execute("/tmp/fsdb/core.db","select * from detailed_calls")
		local call_info = {}
		local cnt = 1
		for i,j in ipairs(call_detailed_info) do
			local tmp ={}

			if j.call_uuid then
				local src_name = j.name or ""
				local dst_name = j.b_name or ""
				local dst_number = j.b_dest or j.dst or ""
				local src_number = j.b_cid_num or j.cid_num or ""

				if ("RINGING" == j.callstate or "DOWN" == j.callstate) then
					for k,v in pairs(call_detailed_info) do
						if ("RINGING" == v.callstate or "EARLY" == v.callstate or "DOWN" == v.callstate or "RING_WAIT" == v.callstate) and v.uuid == j.call_uuid then
							dst_name = j.name or ""
							src_name = v.name or ""
							dst_number = j.dest or ""
							src_number = j.cid_num or ""
						end
					end
				end

				tmp.Index = cnt
				tmp.Src = full_name(src_name)
				tmp.Dest = full_name(dst_name)
				tmp.Caller = src_number
				tmp.Called = dst_number
				tmp.StartTime = os.date("%X", j.created_epoch)
				if j.b_created then
					tmp.AnswerTime = os.date("%X", j.call_created_epoch)
				else
					tmp.AnswerTime = ""
				end
				tmp.State = (j.callstate == "EARLY") and "RINGING" or j.callstate
				if tmp.AnswerTime ~= "" then
				    tmp.Durations = tonumber(os.time()) - tonumber(j.call_created_epoch)
				else
					tmp.Durations = tonumber(os.time()) - tonumber(j.created_epoch)
				end
				table.insert(call_info,tmp)
				cnt = cnt + 1
			end
		end

		luci.http.prepare_content("application/json")
		luci.http.write_json(call_info)

		return
	end
-%>

<%+header%>

<script type="text/javascript" src="<%=resource_cbi_js%>"></script>
<script type="text/javascript" src="<%=resource%>/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
var filtering_flag = false
var timeout = 0
$(document).ready(function(){
    $('.filter').click(function(){
		$filters = $('.filters input')
		$tbody = $('.content tbody')
		if ($filters.prop('disabled') == true) {
			$('.filters').show()
			$filters.prop('disabled', false)
			$filters.last().focus()
			filtering_flag = true
		} else {
			$('.filters').hide()
			$filters.val('').prop('disabled', true)
			$tbody.find('.no-result').remove()
			$tbody.find('tr').show()
			filtering_flag = false
		}
	})

	$('.filters input').keyup(function(e){
		var code = e.keyCode || e.which
		if (code == '9') return
		var $input = $(this)
		inputContent = $input.val().toLowerCase()
		$panel = $input.parents('.filters')
		column = $panel.find('td').index($input.parents('td'))
		$table = $('.content')
		$rows = $table.find('tbody tr')
		/* Dirtiest filter function ever ;) */
		var $filteredRows = $rows.filter(function(){
			var value = $(this).find('td').eq(column).text().toLowerCase()
			return value.indexOf(inputContent) === -1
		});
		/* Clean previous no-result if exist */
		$table.find('tbody .no-result').remove()
		/* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
		$rows.show()
		$filteredRows.hide()
		/* Prepend no-result row if all rows are filtered */
		if ($filteredRows.length === $rows.length) {
			$table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="9"><%:No result found%></td></tr>'));
		}
	})
});
var tmr;
function add_zero(value)
{
	return (value >= 10) ? value : ("0" + value)
}
function translate_src_dst(str)
{
	if(str.indexOf("SIP Trunk") >= 0)
		return str.replace("SIP Trunk","<%=translate('SIP Trunk')%>")
	else if(str.indexOf("SIP Extension") >= 0)
		return str.replace("SIP Extension","<%=translate('SIP Extension')%>")
	else if(str.indexOf("SIP Profile") >= 0)
		return str.replace("SIP Profile","<%=translate('SIP Profile')%>")
	else if(str.indexOf("Ringgroup") >= 0)
		return str.replace("Ringgroup","<%=translate('Ring Group')%>")
	else
		return str
}
function translate_call_state(str)
{
	if("ACTIVE"==str)
		return "<%:TALKING%>"
	else if("RINGING"==str||"EARLY"==str||"RING_WAIT"==str)
		return "<%:RINGING%>"
	else if("DOWN"==str)
		return "---"
	else
		return str
}
function RefreshDuration()
{
	$("table tr").each(function()
	{
		var str = $(this).find("td").last().text()
		if ( "" != str)
		{
			var time = str.split(":")
			var hour = parseInt(time[0],10)
			var min = parseInt(time[1],10)
			var sec = parseInt(time[2],10)

			var sec_total = hour * 3600 + min * 60 + sec + 1

			hour = add_zero(Math.floor(sec_total / 3600))
			min = add_zero(Math.floor((sec_total % 3600) / 60))
			sec = add_zero(Math.floor(sec_total % 60))

			str = hour + ":" + min + ":" + sec
			if($(this).find("td").length == 9)
				$(this).find("td").last().text(str)
		}
	});
}
XHR.poll(3, '<%=REQUEST_URI%>', { status: 1 },
	function(x, info)
	{
		if (null == info)
		{
			timeout += 1
			if (timeout >= 3)
				document.location = document.location.protocol+"//"+document.location.host
		}
		else
		{
			timeout = 0
		}

		$("table.content tbody").empty();
		clearInterval(tmr)
		for(i = 0;i < info.length;i++)
		{
			var str = ""
			var time

			if(1 == i%2)
				str += "<tr class=cbi-rowstyle-odd " + ">"
			else
				str += "<tr class=cbi-rowstyle-even " + ">"

			str += "<td>" + info[i]["Index"] + "</td>"
			str += "<td>" + translate_src_dst(info[i]["Src"]) + "</td>"
			str += "<td>" + translate_src_dst(info[i]["Dest"]) + "</td>"
			str += "<td>" + info[i]["Caller"] + "</td>"
			str += "<td>" + info[i]["Called"] + "</td>"
			str += "<td> " + info[i]["StartTime"] + "</td>"
			str += "<td>" + info[i]["AnswerTime"] + "</td>"
			str += "<td> " + translate_call_state(info[i]["State"]) + "</td>"

			time = new Date(info[i]["Durations"] * 1000)
			str += "<td>" + add_zero(time.getUTCHours()) + ":" + add_zero(time.getUTCMinutes()) + ":" + add_zero(time.getUTCSeconds()) + "</td></tr>"
			$("table.content tbody").append(str)
			if(true == filtering_flag)
				$(".filters input").each(function(){
					if($(this).val().length > 0)
						$(this).keyup()
				})
		}
		if(info.length)
			tmr = window.setInterval("RefreshDuration()",1000)
	}
);
</script>
<style type="text/css">
table td {overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
table {table-layout:fixed;}
</style>
<h2><a id="content" name="content"><%:Status / Current Call%></a></h2>
<fieldset class="cbi-section">
	<table class="cbi-section-table">
		<tbody>
			<tr class="cbi-section-table-titles">
				<table>
					<tr>
						<th width="5%" ><%:Index%></th>
						<th width="18%" ><%:Src%></th>
						<th width="16%" ><%:Dest%></th>
						<th width="10%" ><%:Caller%></th>
						<th width="10%" ><%:Called%></th>
						<th width="10%" ><%:Start Time%></th>
						<th width="10%" ><%:Answer Time%></th>
						<th width="9%" ><%:State%></th>
						<th width="6%" style="text-align:right;"><%:Duration%></th>
						<th width="6%"><button class="btn filter button-filter"><%:Filter%></button></th>
					</tr>
					<tr class="filters" style="display:none;">
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td colspan="2"><input type="text" disabled="disable"></td>
					</tr> 
				</table>
			</tr>
			<div style="overflow-y:auto; width=100%; height:500px">
				<table class="content" >
					<colgroup>
					<col style="width: 5%">
					<col style="width: 18%">
					<col style="width: 16%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 9%">
					<col style="width: 12%">
					</colgroup>
					<tbody >
						
					</tbody>
				</table>
			</div>
		</tbody>
	</table>
</fieldset>
<%+footer%>
