#!/bin/sh

cp /tmp/firmware_upgrading_temp/oem/etc/config/* /usr/lib/lua/luci/scripts/default_config/
cp /tmp/firmware_upgrading_temp/oem/oem /etc/config/oem
cp /tmp/firmware_upgrading_temp/oem/luci /usr/lib/lua/ -rf
cp /tmp/firmware_upgrading_temp/oem/icons /www/luci-static/resources/ -rf
cp /tmp/firmware_upgrading_temp/oem/bin/network_watch /bin/network_watch
cp /tmp/firmware_upgrading_temp/oem/bin/restore_default /bin/restore_default
cp /tmp/firmware_upgrading_temp/oem/bin/restore_factory /bin/restore_factory
cp /tmp/firmware_upgrading_temp/oem/etc/freeswitch/conf/autoload_configs/lua.conf.xml /etc/freeswitch/conf/autoload_configs/lua.conf.xml
cp /tmp/firmware_upgrading_temp/oem/etc/freeswitch/scripts/service_state_log.lua /etc/freeswitch/scripts/service_state_log.lua
cp /tmp/firmware_upgrading_temp/oem/etc/openvpn/client_down.sh /etc/openvpn/client_down.sh
cp /tmp/firmware_upgrading_temp/oem/etc/openvpn/client_up.sh /etc/openvpn/client_up.sh
cp /tmp/firmware_upgrading_temp/oem/lib/netifd/ppp-down /lib/netifd/ppp-down
cp /tmp/firmware_upgrading_temp/oem/lib/netifd/ppp-up /lib/netifd/ppp-up
cp /tmp/firmware_upgrading_temp/oem/usr/bin/cron_app.sh /usr/bin/cron_app.sh
cp /tmp/firmware_upgrading_temp/oem/usr/lib/ddns/dynamic_dns_functions.sh /usr/lib/ddns/dynamic_dns_functions.sh
cp /tmp/firmware_upgrading_temp/oem/usr/lib/ddns/dynamic_dns_updater.sh /usr/lib/ddns/dynamic_dns_updater.sh

uci set lucid.http.address=80
uci add_list lucid.http.address=8345
uci add_list lucid.http.address=8848
uci commit lucid

if [ -f "/usr/lib/lua/luci/controller/mini/index.lua" ]; then
	cp /tmp/firmware_upgrading_temp/oem/etc/config/* /etc/config/
	uci set system.main.zonename=Asia/Beijing
	uci set system.main.timezone=CST-8
	uci commit system
else
	uci set system.main.zonename=Asia/Beijing
	uci set system.main.timezone=CST-8

	uci set firewall.defaults.enabled_8345=1
	uci set firewall.defaults.enabled_8848=0

	uci delete firewall.redirecta -q
	section=`uci add firewall redirect`
	section_name="redirecta"
	uci set firewall.${section}.name='Allow-8345'
	uci set firewall.${section}.src='wan'
	uci set firewall.${section}.src_dport='8345'
	uci set firewall.${section}.dest_port='8345'
	uci set firewall.${section}.enabled='1'
	uci rename firewall.${section}=${section_name}

	uci delete firewall.rulea -q
	section=`uci add firewall rule`
	section_name="rulea"
	uci set firewall.${section}.name='Allow-8345'
	uci set firewall.${section}.src='wan'
	uci set firewall.${section}.dest_port='8345'
	uci set firewall.${section}.target='ACCEPT'
	uci set firewall.${section}.enabled='1'
	uci rename firewall.${section}=${section_name}

	uci delete firewall.redirectb -q
	section=`uci add firewall redirect`
	section_name="redirectb"
	uci set firewall.${section}.name='Allow-8848'
	uci set firewall.${section}.src='wan'
	uci set firewall.${section}.src_dport='8848'
	uci set firewall.${section}.dest_port='8848'
	uci set firewall.${section}.enabled='1'
	uci rename firewall.${section}=${section_name}

	uci delete firewall.ruleb -q
	section=`uci add firewall rule`
	section_name="ruleb"
	uci set firewall.${section}.name='Allow-8848'
	uci set firewall.${section}.src='wan'
	uci set firewall.${section}.dest_port='8848'
	uci set firewall.${section}.target='REJECT'
	uci set firewall.${section}.enabled='1'
	uci rename firewall.${section}=${section_name}

	uci commit system
	uci commit firewall
fi

echo > /usr/lib/opkg/info/oem.list
cat > /usr/lib/opkg/info/oem.list << EOF
/www/luci-static/resources/icons/correct.png
/www/luci-static/resources/icons/error.png
/www/luci-static/resources/icons/info.png
/usr/lib/lua/luci/controller/admin/advanced.lua
/usr/lib/lua/luci/controller/admin/affair.lua
/usr/lib/lua/luci/controller/admin/detailset.lua
/usr/lib/lua/luci/controller/admin/wizard.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/ddns.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/l2tp_client.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/net_access.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/pptp_client.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/sim.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/siptrunk.lua
/usr/lib/lua/luci/model/cbi/admin_wizard/wlan_ap.lua
/usr/lib/lua/luci/model/cbi/admin_wizard
/usr/lib/lua/luci/model/cbi/admin_detailset/ddns.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/l2tp_client.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/net_access.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/pptp_client.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/sim.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/siptrunk.lua
/usr/lib/lua/luci/model/cbi/admin_detailset/wlan_ap.lua
/usr/lib/lua/luci/model/cbi/admin_detailset
/usr/lib/lua/luci/view/admin_advanced/detect.htm
/usr/lib/lua/luci/view/admin_advanced/flashops.htm
/usr/lib/lua/luci/view/admin_advanced/applyreboot.htm
/usr/lib/lua/luci/view/admin_advanced
/usr/lib/lua/luci/view/admin_affair/index.htm
/usr/lib/lua/luci/view/admin_affair/index_empty.htm
/usr/lib/lua/luci/view/admin_affair/service_state.htm
/usr/lib/lua/luci/view/admin_affair
/usr/lib/lua/luci/view/admin_detailset/openvpn.htm
/usr/lib/lua/luci/view/admin_detailset/ssid.htm
/usr/lib/lua/luci/view/admin_detailset
/usr/lib/lua/luci/view/admin_wizard/description.htm
/usr/lib/lua/luci/view/admin_wizard/footer.htm
/usr/lib/lua/luci/view/admin_wizard/openvpn.htm
/usr/lib/lua/luci/view/admin_wizard/ssid.htm
/usr/lib/lua/luci/view/admin_wizard/vpn.htm
/usr/lib/lua/luci/view/admin_wizard/wizard.htm
/usr/lib/lua/luci/view/admin_wizard
/usr/lib/lua/luci/scripts/default_config/custom_reset.lua
/etc/freeswitch/scripts/service_state_log.lua
EOF

/etc/init.d/firewall restart >/dev/null 2>&1
/etc/init.d/lucid restart >/dev/null 2>&1
