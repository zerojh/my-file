<%
--[[
	local sqlite = require "luci.scripts.sqlite3_service"
	local uci = require "luci.model.uci".cursor()

	if luci.http.formvalue("status") == "1" then
		return
	end
]]--
-%>

<%+header%>

<script type="text/javascript" src="<%=resource_cbi_js%>"></script>
<script type="text/javascript" src="<%=resource%>/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
function filter_result()
{
	$("#filter-id").toggle();
	keyup_event();
}

function keyup_event()
{
	$(".connfilter").val("");

	/* Simulate a keyup event. */
	var e = $.Event("keyup");
	e.which = 13;
	$(".connfilter").trigger(e);
}

function get_list()
{
	XHR.poll(3, '<%=REQUEST_URI%>', { status: 1 },
		function(x, info)
		{
			if (null == info)
			{
				timeout += 1
				if (timeout >= 3)
					document.location = document.location.protocol+"//"+document.location.host
			}
			else
			{
				timeout = 0
			}

			$("table.content tbody").empty();
			clearInterval(tmr)
			for(i = 0;i < info.length;i++)
			{
				var str = ""
				var time

				if(1 == i%2)
					str += "<tr class=cbi-rowstyle-odd " + ">"
				else
					str += "<tr class=cbi-rowstyle-even " + ">"

				str += "<td>" + info[i]["Index"] + "</td>"
				str += "<td>" + translate_src_dst(info[i]["Src"]) + "</td>"
				str += "<td>" + translate_src_dst(info[i]["Dest"]) + "</td>"
				str += "<td>" + info[i]["Caller"] + "</td>"
				str += "<td>" + info[i]["Called"] + "</td>"
				str += "<td> " + info[i]["StartTime"] + "</td>"
				str += "<td>" + info[i]["AnswerTime"] + "</td>"
				str += "<td> " + translate_call_state(info[i]["State"]) + "</td>"

				time = new Date(info[i]["Durations"] * 1000)
				str += "<td>" + add_zero(time.getUTCHours()) + ":" + add_zero(time.getUTCMinutes()) + ":" + add_zero(time.getUTCSeconds()) + "</td></tr>"
				$("table.content tbody").append(str)
				if(true == filtering_flag)
					$(".filters input").each(function(){
						if($(this).val().length > 0)
							$(this).keyup()
					})
			}
			if(info.length)
				tmr = window.setInterval("RefreshDuration()",1000)
		}
	);
}

$(document).ready(function(){
	$(".connfilter").keyup(function(e) {
		$(".no-result").remove();
		/* ignore tab. */
		var code = e.keyCode || e.which;
		if ("9" == code) {
			return;
		}

		var $input = $(this),
		inputContent = $input.val().toLowerCase(),
		$panel = $input.parents("#filter-id"),
		column = $panel.find("td").index($input.parents("td"))
		$table = $(".connlist").parent("tr"),
		$rows = $table;
		var $filteredRows = $rows.filter(function() {
			var value = $(this).find("td").eq(column).text().toLowerCase();
			return value.indexOf(inputContent) === -1;
		});
		$rows.show();
		$filteredRows.hide();
		if ($filteredRows.length === $rows.length) {
			$("#content-id").append($('<tr class="no-result"><td colspan="6"><%:No result found%></td></tr>'));
		}
	});
	$("#content-id").append($('<tr class="loading-now"><td colspan="6"><img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>"/></td></tr>'));

	get_list()
});

</script>
<style type="text/css">
table td {overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
table {table-layout:fixed;}
</style>
<h2><a id="content" name="content"><%:Status / Current Call%></a></h2>
<fieldset class="cbi-section">
	<table class="cbi-section-table">
		<tbody>
			<tr class="cbi-section-table-titles">
				<table>
					<tr>
						<th width="5%" ><%:Index%></th>
						<th width="18%" ><%:Src%></th>
						<th width="16%" ><%:Dest%></th>
						<th width="10%" ><%:Caller%></th>
						<th width="10%" ><%:Called%></th>
						<th width="10%" ><%:Start Time%></th>
						<th width="10%" ><%:Answer Time%></th>
						<th width="9%" ><%:State%></th>
						<th width="6%" style="text-align:right;"><%:Duration%></th>
						<th width="6%"><button class="btn filter button-filter"><%:Filter%></button></th>
					</tr>
					<tr class="filters" style="display:none;">
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td><input type="text" disabled="disable"></td>
						<td colspan="2"><input type="text" disabled="disable"></td>
					</tr>
				</table>
			</tr>
			<div style="overflow-y:auto; width=100%; height:500px">
				<table class="content" >
					<colgroup>
					<col style="width: 5%">
					<col style="width: 18%">
					<col style="width: 16%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 10%">
					<col style="width: 9%">
					<col style="width: 12%">
					</colgroup>
					<tbody >
						
					</tbody>
				</table>
			</div>
		</tbody>
	</table>
</fieldset>
<%+footer%>
